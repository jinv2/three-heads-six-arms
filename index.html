<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ä¸‰å¤´å…­è‡‚åˆ›ä¸–ç³»ç»Ÿ - è¶…çº§ä¸ªä½“è·¨ç•Œèµ‹èƒ½å¹³å°</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        /* åŸºç¡€é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 15px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            background-attachment: fixed;
            color: #fff;
            min-height: 100vh;
            line-height: 1.5;
            font-size: 16px;
        }
        
        /* å®¹å™¨å“åº”å¼ */
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(15px);
            padding: 20px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        @media (min-width: 768px) {
            .container {
                padding: 30px;
                border-radius: 25px;
            }
        }
        
        /* æ ‡é¢˜å“åº”å¼ */
        h1 {
            text-align: center;
            font-size: 2.2rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00dbde, #fc00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        
        @media (min-width: 768px) {
            h1 {
                font-size: 3.5rem;
            }
        }
        
        .subtitle {
            text-align: center;
            opacity: 0.9;
            margin-bottom: 25px;
            font-size: 1rem;
            line-height: 1.4;
        }
        
        @media (min-width: 768px) {
            .subtitle {
                font-size: 1.2rem;
                margin-bottom: 40px;
            }
        }
        
        /* è¾“å…¥åŒºåŸŸå“åº”å¼ */
        textarea {
            width: 100%;
            height: 140px;
            padding: 16px;
            border: 2px solid rgba(0,219,222,0.3);
            border-radius: 15px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 16px;
            margin-bottom: 20px;
            resize: vertical;
            transition: all 0.3s;
            font-family: inherit;
            line-height: 1.5;
        }
        
        textarea:focus {
            outline: none;
            border-color: #00dbde;
            box-shadow: 0 0 20px rgba(0,219,222,0.2);
        }
        
        textarea::placeholder {
            color: rgba(255,255,255,0.4);
            font-size: 15px;
        }
        
        @media (min-width: 768px) {
            textarea {
                height: 120px;
                padding: 20px;
            }
        }
        
        /* æŒ‰é’®å“åº”å¼ */
        .generate-btn {
            background: linear-gradient(90deg, #00dbde, #fc00ff);
            color: white;
            border: none;
            padding: 18px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            letter-spacing: 1px;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
        }
        
        .generate-btn:active {
            transform: scale(0.98);
        }
        
        .generate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,219,222,0.3);
        }
        
        @media (min-width: 768px) {
            .generate-btn {
                padding: 18px 50px;
            }
        }
        
        /* ç»“æœåŒºåŸŸå“åº”å¼ */
        .results {
            margin-top: 35px;
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            color: #00dbde;
            border-left: 4px solid #fc00ff;
            padding-left: 15px;
            margin: 25px 0 15px;
            font-size: 1.3rem;
        }
        
        @media (min-width: 768px) {
            .section-title {
                margin: 30px 0 20px;
                font-size: 1.5rem;
            }
        }
        
        /* å¡ç‰‡å“åº”å¼ */
        .analysis-card {
            background: linear-gradient(145deg, rgba(0,219,222,0.1), rgba(252,0,255,0.05));
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .analysis-card h3 {
            color: #00dbde;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .gene-card {
            background: rgba(255,255,255,0.05);
            padding: 18px;
            border-radius: 12px;
            margin: 12px 0;
            border-left: 4px solid #00dbde;
            transition: all 0.3s;
        }
        
        .gene-card:hover {
            background: rgba(255,255,255,0.08);
        }
        
        @media (min-width: 768px) {
            .analysis-card {
                padding: 25px;
            }
            
            .gene-card {
                padding: 20px;
            }
        }
        
        /* æ ‡ç­¾å“åº”å¼ */
        .gene-tag {
            display: inline-block;
            background: rgba(0,219,222,0.2);
            color: #00dbde;
            padding: 5px 12px;
            border-radius: 20px;
            margin: 4px 4px 4px 0;
            font-size: 0.8rem;
            border: 1px solid rgba(0,219,222,0.3);
        }
        
        /* å…­è‡‚æŒ‰é’®å“åº”å¼ */
        .arm-button {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 18px;
            margin: 6px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: inline-block;
            touch-action: manipulation;
            min-width: 80px;
            text-align: center;
        }
        
        .arm-button:active {
            transform: scale(0.95);
        }
        
        @media (min-width: 768px) {
            .arm-button {
                padding: 10px 25px;
                margin: 8px;
            }
        }
        
        /* å•†ä¸šé¢æ¿å“åº”å¼ */
        .commercial-panel {
            background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,140,0,0.05));
            padding: 20px;
            border-radius: 20px;
            margin-top: 35px;
            border: 1px solid rgba(255,215,0,0.2);
            display: none;
        }
        
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .pricing-card {
            background: rgba(255,255,255,0.08);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .pricing-card.featured {
            border: 2px solid #00dbde;
            transform: scale(1.05);
        }
        
        .pricing-card h3 {
            color: #00dbde;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        
        .price {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 15px 0;
            color: #fc00ff;
        }
        
        @media (min-width: 768px) {
            .commercial-panel {
                padding: 30px;
            }
            
            .pricing-grid {
                gap: 20px;
            }
            
            .pricing-card {
                padding: 25px;
            }
            
            .price {
                font-size: 2.5rem;
            }
        }
        
        /* å·¥å…·æŒ‰é’®å“åº”å¼ */
        .tool-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .tool-button {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 18px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 140px;
            touch-action: manipulation;
        }
        
        .tool-button:active {
            transform: scale(0.95);
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            text-align: center;
            padding: 30px;
            font-size: 1.1rem;
        }
        
        .loading-dots:after {
            content: ' .';
            animation: dots 1.5s steps(5, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60% { content: ' ...'; }
            80%, 100% { content: ' ...'; }
        }
        
        /* çŠ¶æ€å¾½ç«  */
        .status-badge {
            display: inline-block;
            background: rgba(0,255,127,0.2);
            color: #00ff7f;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 8px;
            border: 1px solid rgba(0,255,127,0.3);
        }
        
        @media (min-width: 768px) {
            .status-badge {
                margin-left: 10px;
                margin-top: 0;
            }
        }
        
        /* é¡µè„šå“åº”å¼ */
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 25px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.85rem;
            opacity: 0.7;
        }
        
        footer p {
            margin: 5px 0;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 480px) {
            body {
                padding: 12px;
            }
            
            .container {
                padding: 18px;
                border-radius: 18px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .subtitle {
                font-size: 0.9rem;
                margin-bottom: 20px;
            }
            
            textarea {
                height: 120px;
                padding: 14px;
                font-size: 15px;
            }
            
            .generate-btn {
                padding: 16px 25px;
                font-size: 16px;
            }
            
            .section-title {
                font-size: 1.2rem;
                margin: 20px 0 12px;
            }
            
            .analysis-card {
                padding: 18px;
            }
            
            .analysis-card h3 {
                font-size: 1.1rem;
            }
            
            .arm-button {
                padding: 10px 15px;
                margin: 4px;
                font-size: 0.85rem;
                min-width: 70px;
            }
            
            .pricing-grid {
                grid-template-columns: 1fr;
            }
            
            .pricing-card.featured {
                transform: none;
            }
            
            .tool-button {
                min-width: 120px;
                padding: 10px 15px;
                font-size: 0.85rem;
            }
        }
        
        /* é˜²æ­¢IOSç¼©æ”¾é—®é¢˜ */
        input, textarea, select {
            font-size: 16px !important;
        }
        
        /* è§¦æ‘¸æ»šåŠ¨ä¼˜åŒ– */
        .analysis-card, .gene-card, .pricing-card {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <h1>ğŸ§¬ ä¸‰å¤´å…­è‡‚åˆ›ä¸–ç³»ç»Ÿ</h1>
        <p class="subtitle">è¶…çº§ä¸ªä½“è·¨ç•Œèµ‹èƒ½å¹³å° Â· åŸºäºå…±ç”Ÿåè®® v2.0 <br><span class="status-badge">æ™ºèƒ½å¼•æ“å·²ä¸Šçº¿</span></p>
        
        <!-- è¾“å…¥åŒºåŸŸ -->
        <div>
            <textarea id="userInput" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„ä¸“ä¸šèƒ½åŠ›ã€ç»éªŒæˆ–æƒ³è§£å†³çš„é—®é¢˜...

ä¾‹å¦‚ï¼š
â€¢ æˆ‘æ˜¯ä¸€åæ‚¬ç–‘å°è¯´ä½œå®¶ï¼Œæ“…é•¿åˆ¶é€ æ‚¬å¿µå’Œåè½¬
â€¢ æˆ‘æ˜¯ç‹¬ç«‹éŸ³ä¹åˆ¶ä½œäººï¼Œç²¾é€šç”µå­éŸ³ä¹ç¼–æ›²
â€¢ æˆ‘ä»äº‹å“ç‰Œè§†è§‰è®¾è®¡ï¼Œéœ€è¦ä¸ºä¼ ç»Ÿè¡Œä¸šåˆ›æ–°
â€¢ æˆ‘æ˜¯æˆå‰§å¯¼æ¼”ï¼Œæƒ³è¦å°†èˆå°ç»éªŒåº”ç”¨äºå•†ä¸šåŸ¹è®­"></textarea>
            <button class="generate-btn" onclick="generateSmartPlan()">
                ğŸš€ ç”Ÿæˆæ™ºèƒ½è·¨ç•Œæ–¹æ¡ˆ
            </button>
        </div>
        
        <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div class="results" id="results">
            <h2 class="section-title">ğŸ¯ æ™ºèƒ½åˆ†ææŠ¥å‘Š</h2>
            
            <!-- æ™ºèƒ½åˆ†æå¡ç‰‡ -->
            <div class="analysis-card" id="analysisSection">
                <h3>ğŸ§  ç³»ç»Ÿç†è§£ä¸åˆ†æ</h3>
                <div id="analysisContent">
                    <p>æ­£åœ¨åˆ†ææ‚¨çš„ä¸“ä¸šèƒŒæ™¯ä¸æ½œåœ¨éœ€æ±‚...</p>
                </div>
            </div>
            
            <!-- æ–¹æ³•åŸºå› å±•ç¤º -->
            <h3 class="section-title">ğŸ”¬ åŒ¹é…çš„æ–¹æ³•åŸºå› </h3>
            <div id="genesSection">
                <p>æ­£åœ¨ä¸ºæ‚¨åŒ¹é…é«˜ç›¸å…³çš„æ–¹æ³•è®ºåŸºå› ...</p>
            </div>
            
            <!-- ä¸‰å¤´å…­è‡‚æ–¹æ¡ˆ -->
            <h3 class="section-title">ğŸ­ ä¸‰å¤´å…­è‡‚èµ‹èƒ½æ–¹æ¡ˆ</h3>
            <div class="analysis-card">
                <!-- ä¸‰å¤´ç½‘æ ¼ï¼ˆç§»åŠ¨ç«¯æ”¹ä¸ºå‚ç›´ï¼Œæ¡Œé¢ç«¯æ°´å¹³ï¼‰ -->
                <div id="threeHeadsGrid">
                    <!-- ç§»åŠ¨ç«¯ï¼šå‚ç›´å¸ƒå±€ -->
                    <div class="head-item">
                        <h4>ğŸ“– æ–‡å­¦å¤´</h4>
                        <p id="literatureHead">æ­£åœ¨æ„å»ºå™äº‹æ¡†æ¶...</p>
                    </div>
                    <div class="head-item">
                        <h4>ğŸµ éŸ³ä¹å¤´</h4>
                        <p id="musicHead">æ­£åœ¨è®¾è®¡èŠ‚å¥ç»“æ„...</p>
                    </div>
                    <div class="head-item">
                        <h4>ğŸ¬ å½±è§†å¤´</h4>
                        <p id="filmHead">æ­£åœ¨ç­–åˆ’è§†è§‰è¡¨è¾¾...</p>
                    </div>
                </div>
                
                <!-- å…­è‡‚æ‰§è¡Œç³»ç»Ÿ -->
                <div style="margin-top: 25px;">
                    <h4>ğŸ¦¾ å…­è‡‚æ‰§è¡Œç³»ç»Ÿ</h4>
                    <div id="sixArmsGrid">
                        <button class="arm-button" onclick="armFunction('diagnose')">è¯Šæ–­</button>
                        <button class="arm-button" onclick="armFunction('graft')">å«æ¥</button>
                        <button class="arm-button" onclick="armFunction('architect')">æ¶æ„</button>
                        <button class="arm-button" onclick="armFunction('material')">ç‰©æ–™</button>
                        <button class="arm-button" onclick="armFunction('monetize')">å˜ç°</button>
                        <button class="arm-button" onclick="armFunction('collaborate')">ååŒ</button>
                    </div>
                    <div id="executionDetails" style="margin-top: 20px;">
                        <p>ç‚¹å‡»ä»»ä¸€æ‰§è¡Œè‡‚æŸ¥çœ‹è¯¦ç»†æ–¹æ¡ˆ...</p>
                    </div>
                </div>
            </div>
            
            <!-- å•†ä¸šåŒ–å…¥å£ -->
            <div style="text-align: center; margin: 35px 0;">
                <button class="generate-btn" onclick="showCommercialPanel()">
                    ğŸ’° ç«‹å³è½¬åŒ–ä¸ºå•†ä¸šé¡¹ç›®
                </button>
            </div>
        </div>
        
        <!-- å•†ä¸šåŒ–é¢æ¿ -->
        <div class="commercial-panel" id="commercialPanel">
            <h2 class="section-title">å•†ä¸šè½¬åŒ–ä¸­å¿ƒ</h2>
            
            <!-- å®šä»·æ–¹æ¡ˆç½‘æ ¼ -->
            <div class="pricing-grid">
                <div class="pricing-card">
                    <h3>ä½“éªŒç‰ˆ</h3>
                    <div class="price">Â¥299</div>
                    <p>å•æ¬¡æ·±åº¦åˆ†ææŠ¥å‘Š</p>
                    <button class="arm-button" onclick="selectPlan('trial')">ç«‹å³ä½“éªŒ</button>
                </div>
                <div class="pricing-card featured">
                    <h3>ä¸“ä¸šç‰ˆ</h3>
                    <div class="price">Â¥999</div>
                    <p>æœˆåº¦æ— é™ç”Ÿæˆ + å•†ä¸šå·¥å…·</p>
                    <button class="arm-button" style="background: linear-gradient(90deg, #00dbde, #fc00ff);" 
                            onclick="selectPlan('pro')">
                        è®¢é˜…ä¸“ä¸šç‰ˆ
                    </button>
                </div>
                <div class="pricing-card">
                    <h3>ä¼ä¸šç‰ˆ</h3>
                    <div class="price">Â¥9,999</div>
                    <p>å¹´åº¦åˆä¼™äºº + å®šåˆ¶æœåŠ¡</p>
                    <button class="arm-button" onclick="selectPlan('enterprise')">å®šåˆ¶å’¨è¯¢</button>
                </div>
            </div>
            
            <!-- å•†ä¸šå·¥å…·ç®± -->
            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px;">
                <h3>å•†ä¸šå·¥å…·ç®±</h3>
                <div class="tool-buttons">
                    <button class="tool-button" onclick="generateQuote()">
                        <span>ğŸ“„</span> æŠ¥ä»·å•
                    </button>
                    <button class="tool-button" onclick="createProposal()">
                        <span>ğŸ“‹</span> ææ¡ˆ
                    </button>
                    <button class="tool-button" onclick="showContract()">
                        <span>ğŸ“‘</span> åˆåŒ
                    </button>
                    <button class="tool-button" onclick="calculateROI()">
                        <span>ğŸ“Š</span> ROIåˆ†æ
                    </button>
                    <button class="tool-button" onclick="paymentOptions()">
                        <span>ğŸ’³</span> æ”¯ä»˜
                    </button>
                </div>
                <div id="commercialOutput" style="margin-top: 20px;"></div>
            </div>
        </div>
        
        <footer>
            <p>Â© 2024 ä¸‰å¤´å…­è‡‚åˆ›ä¸–ç³»ç»Ÿ | æ™ºèƒ½åŸºå› åº“ v2.0 | åè®®é©±åŠ¨ Â· é›†ä½“è¿›åŒ–</p>
            <p style="font-size: 0.8rem; margin-top: 10px;">
                GitHub: jinv2/three-heads-six-arms | 
                <span id="apiStatus" style="color: #00ff7f;">äº‘ç«¯æ™ºèƒ½å¼•æ“ âœ“ åœ¨çº¿</span>
            </p>
        </footer>
    </div>

    <script>
    // ==================== å…¨å±€çŠ¶æ€ä¸é…ç½® ====================
    let currentAnalysis = null;
    let currentGenes = [];
    
    // ==================== ç§»åŠ¨ç«¯å¸ƒå±€ä¼˜åŒ– ====================
    function updateLayout() {
        const isMobile = window.innerWidth < 768;
        const threeHeadsGrid = document.getElementById('threeHeadsGrid');
        const sixArmsGrid = document.getElementById('sixArmsGrid');
        
        if (threeHeadsGrid) {
            threeHeadsGrid.style.display = isMobile ? 'block' : 'grid';
            threeHeadsGrid.style.gridTemplateColumns = isMobile ? '1fr' : 'repeat(3, 1fr)';
            threeHeadsGrid.style.gap = isMobile ? '20px' : '25px';
            
            // æ›´æ–°å­å…ƒç´ ç±»å
            Array.from(threeHeadsGrid.children).forEach(child => {
                child.className = isMobile ? 'head-item' : 'head-item';
            });
        }
        
        if (sixArmsGrid) {
            sixArmsGrid.style.gridTemplateColumns = isMobile ? 'repeat(2, 1fr)' : 'repeat(3, 1fr)';
            sixArmsGrid.style.gap = isMobile ? '10px' : '15px';
        }
    }
    
    // ==================== æ™ºèƒ½ç†è§£å¼•æ“è°ƒç”¨ ====================
    async function generateSmartPlan() {
        const userInput = document.getElementById('userInput').value.trim();
        if (!userInput) {
            alert('è¯·è¾“å…¥æ‚¨çš„ä¸“ä¸šæè¿°');
            return;
        }
        
        // æ˜¾ç¤ºç»“æœåŒºåŸŸå’ŒåŠ è½½çŠ¶æ€
        document.getElementById('results').style.display = 'block';
        document.getElementById('analysisContent').innerHTML = 
            '<div class="loading"><span class="loading-dots">æ­£åœ¨æ·±åº¦åˆ†ææ‚¨çš„ä¸“ä¸šèƒŒæ™¯</span></div>';
        document.getElementById('genesSection').innerHTML = 
            '<p class="loading"><span class="loading-dots">åŒ¹é…é«˜ç›¸å…³æ–¹æ³•åŸºå› </span></p>';
        document.getElementById('literatureHead').textContent = 'åˆ†æä¸­...';
        document.getElementById('musicHead').textContent = 'åˆ†æä¸­...';
        document.getElementById('filmHead').textContent = 'åˆ†æä¸­...';
        document.getElementById('executionDetails').innerHTML = '<p>ç­‰å¾…åˆ†æç»“æœ...</p>';
        
        // éšè—å•†ä¸šåŒ–é¢æ¿
        document.getElementById('commercialPanel').style.display = 'none';
        
        // éšè—é”®ç›˜ï¼ˆç§»åŠ¨ç«¯ï¼‰
        document.activeElement?.blur();
        
        // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
        document.getElementById('results').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
        
        try {
            console.log('ğŸ“¡ è°ƒç”¨æ™ºèƒ½ç†è§£å¼•æ“...');
            
            // è°ƒç”¨æ–°çš„æ™ºèƒ½ç†è§£å‡½æ•°
            const response = await fetch('/.netlify/functions/understand-and-match', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ userInput })
            });
            
            if (!response.ok) {
                throw new Error(`APIå“åº”é”™è¯¯: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('âœ… æ”¶åˆ°æ™ºèƒ½åˆ†æç»“æœ:', result);
            
            if (!result.success) {
                throw new Error(result.error || 'åˆ†æå¤±è´¥');
            }
            
            // ä¿å­˜å½“å‰åˆ†æç»“æœ
            currentAnalysis = result.analysis;
            currentGenes = result.data;
            
            // æ›´æ–°APIçŠ¶æ€æ˜¾ç¤º
            document.getElementById('apiStatus').innerHTML = 
                `æ™ºèƒ½å¼•æ“ âœ“ å·²å¤„ç† ${result.analysis.intelligence_level} åˆ†æ`;
            document.getElementById('apiStatus').style.color = '#00ff7f';
            
            // æ˜¾ç¤ºæ™ºèƒ½åˆ†æè¿‡ç¨‹
            renderAnalysis(result);
            
            // æ˜¾ç¤ºåŸºå› åŒ¹é…ç»“æœ
            renderGenes(result);
            
            // ç”Ÿæˆä¸‰å¤´å…­è‡‚æ–¹æ¡ˆ
            renderThreeHeadsSixArms(result);
            
        } catch (error) {
            console.error('âŒ ç”Ÿæˆå¤±è´¥:', error);
            
            // é™çº§åˆ°æœ¬åœ°é€»è¾‘
            document.getElementById('analysisContent').innerHTML = `
                <div style="color: #ff6b6b;">
                    <h4>âš ï¸ æ™ºèƒ½å¼•æ“æš‚æ—¶ä¸å¯ç”¨</h4>
                    <p>ä½¿ç”¨æœ¬åœ°ä¸“å®¶ç³»ç»Ÿä¸ºæ‚¨ç”Ÿæˆæ–¹æ¡ˆ...</p>
                </div>
            `;
            
            // æœ¬åœ°é™çº§æ–¹æ¡ˆ
            generateLocalFallback(userInput);
            
            // æ›´æ–°çŠ¶æ€
            document.getElementById('apiStatus').innerHTML = 
                'æ™ºèƒ½å¼•æ“ âœ— ç¦»çº¿ | ä½¿ç”¨æœ¬åœ°æ¨¡å¼';
            document.getElementById('apiStatus').style.color = '#ff6b6b';
        }
    }
    
    // ==================== æ¸²æŸ“æ™ºèƒ½åˆ†æ ====================
    function renderAnalysis(result) {
        const analysis = result.analysis;
        const isMobile = window.innerWidth < 768;
        
        let analysisHTML = `
            <div style="${isMobile ? '' : 'display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;'}">
                <div>
                    <h4 style="color: #00dbde;">ğŸ“ è¾“å…¥è§£æ</h4>
                    <p>"${analysis.user_input.substring(0, 100)}${analysis.user_input.length > 100 ? '...' : ''}"</p>
                </div>
                <div>
                    <h4 style="color: #00dbde;">ğŸ§  æ™ºèƒ½ç­‰çº§</h4>
                    <p>${analysis.intelligence_level} (${analysis.query_method})</p>
                </div>
            </div>
        `;
        
        if (analysis.matched_scenarios.length > 0) {
            analysisHTML += `
                <div style="margin-top: 20px;">
                    <h4 style="color: #fc00ff;">ğŸ¯ è¯†åˆ«çš„é—®é¢˜åœºæ™¯</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                        ${analysis.matched_scenarios.slice(0, 4).map(scenario => 
                            `<span style="background: rgba(252,0,255,0.2); padding: 6px 12px; border-radius: 20px; 
                              border: 1px solid rgba(252,0,255,0.3); font-size: 0.9rem;">${scenario}</span>`
                        ).join('')}
                    </div>
                </div>
            `;
        }
        
        if (analysis.matched_domains.length > 0) {
            analysisHTML += `
                <div style="margin-top: 15px;">
                    <h4 style="color: #00dbde;">ğŸŒ ç›¸å…³åº”ç”¨é¢†åŸŸ</h4>
                    <p>${analysis.matched_domains.slice(0, 3).join(' â†’ ')}</p>
                </div>
            `;
        }
        
        if (result.recommendations && result.recommendations.length > 0) {
            analysisHTML += `
                <div style="margin-top: 15px; background: rgba(0,219,222,0.1); padding: 15px; border-radius: 10px;">
                    <h4 style="color: #00ff7f;">ğŸ’¡ ç³»ç»Ÿå»ºè®®</h4>
                    <ul style="margin: 10px 0 0 20px; font-size: 0.95rem;">
                        ${result.recommendations.slice(0, 3).map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        document.getElementById('analysisContent').innerHTML = analysisHTML;
    }
    
    // ==================== æ¸²æŸ“æ–¹æ³•åŸºå›  ====================
    function renderGenes(result) {
        if (!result.data || result.data.length === 0) {
            document.getElementById('genesSection').innerHTML = `
                <div style="text-align: center; padding: 25px; color: #ff6b6b;">
                    <h4>âš ï¸ æœªæ‰¾åˆ°é«˜ç›¸å…³æ–¹æ³•åŸºå› </h4>
                    <p>å»ºè®®è°ƒæ•´æè¿°æˆ–æ¢ç´¢é€šç”¨æ–¹æ³•è®º</p>
                </div>
            `;
            return;
        }
        
        let genesHTML = `
            <div style="color: #00ff7f; margin-bottom: 15px; text-align: center;">
                âœ… ä¸ºæ‚¨ç²¾å‡†åŒ¹é… ${result.data.length} ä¸ªæ–¹æ³•åŸºå› 
            </div>
        `;
        
        result.data.slice(0, 3).forEach((gene, index) => {
            const isPrimary = index === 0;
            
            genesHTML += `
                <div class="gene-card" ${isPrimary ? 'style="border-left: 4px solid #fc00ff;"' : ''}>
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0; color: ${isPrimary ? '#fc00ff' : '#00dbde'}">
                                ${isPrimary ? 'â­ ' : ''}${gene.title}
                            </h4>
                            <p style="opacity: 0.8; margin: 5px 0; font-size: 0.9rem;">
                                æ¥æº: ${gene.origin_domain} | å¤æ‚åº¦: ${'â˜…'.repeat(gene.complexity_level)}
                            </p>
                        </div>
                        <button class="arm-button" style="padding: 6px 15px; font-size: 0.85rem;" 
                                onclick="focusGene(${gene.id})">
                            æ·±åº¦åº”ç”¨
                        </button>
                    </div>
                    
                    <p style="margin: 12px 0; line-height: 1.5; font-size: 0.95rem;">${gene.description.substring(0, 120)}${gene.description.length > 120 ? '...' : ''}</p>
                    
                    <div style="margin: 10px 0;">
                        <div style="margin-top: 8px;">
                            ${gene.tags.slice(0, 5).map(tag => `<span class="gene-tag">#${tag}</span>`).join('')}
                        </div>
                    </div>
                    
                    <div style="margin-top: 12px; font-size: 0.9rem;">
                        <strong style="color: #00ff7f;">ğŸš€ å¯åº”ç”¨äº:</strong>
                        <p style="margin: 5px 0; font-size: 0.9rem;">${gene.applicable_domains.slice(0, 3).join(' Â· ')}</p>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('genesSection').innerHTML = genesHTML;
    }
    
    // ==================== ç”Ÿæˆä¸‰å¤´å…­è‡‚æ–¹æ¡ˆ ====================
    function renderThreeHeadsSixArms(result) {
        const genes = result.data;
        const analysis = result.analysis;
        const isMobile = window.innerWidth < 768;
        
        if (genes.length === 0) return;
        
        // æ–‡å­¦å¤´
        const narrativeGenes = genes.filter(g => 
            g.tags.some(t => ['å™äº‹', 'ç»“æ„', 'åŸå‹', 'æ•…äº‹', 'æ‚¬å¿µ'].includes(t))
        );
        document.getElementById('literatureHead').innerHTML = narrativeGenes.length > 0 ?
            `<span style="color: #fc00ff;">${narrativeGenes[0].title}</span> â†’ ${analysis.matched_domains[0] || 'ä¸“ä¸š'}å™äº‹æ¡†æ¶` :
            `åŸºäº${analysis.matched_domains[0] || 'æ‚¨çš„ä¸“ä¸š'}è®¾è®¡åˆ›æ–°å™äº‹`;
        
        // éŸ³ä¹å¤´
        const rhythmGenes = genes.filter(g => 
            g.tags.some(t => ['èŠ‚å¥', 'æƒ…ç»ª', 'å¯¹æ¯”', 'å¾ªç¯', 'ç»“æ„'].includes(t))
        );
        document.getElementById('musicHead').innerHTML = rhythmGenes.length > 0 ?
            `<span style="color: #fc00ff;">${rhythmGenes[0].title}</span> â†’ é¡¹ç›®èŠ‚å¥ä¸æƒ…ç»ªè®¾è®¡` :
            `è®¾è®¡å…·æœ‰${analysis.matched_tags[0] || 'ä¸“ä¸š'}èŠ‚å¥çš„è¡¨è¾¾æ–¹æ¡ˆ`;
        
        // å½±è§†å¤´
        const visualGenes = genes.filter(g => 
            g.tags.some(t => ['è§†è§‰', 'ç©ºé—´', 'æ„è±¡', 'æ„å›¾', 'å¼•å¯¼'].includes(t))
        );
        document.getElementById('filmHead').innerHTML = visualGenes.length > 0 ?
            `<span style="color: #fc00ff;">${visualGenes[0].title}</span> â†’ è§†è§‰è¡¨è¾¾æ–¹æ¡ˆè®¾è®¡` :
            `ç­–åˆ’è·¨åª’ä½“è§†è§‰å™äº‹æ–¹æ¡ˆ`;
        
        // å…­è‡‚æ‰§è¡Œè¯¦æƒ…
        const armDetails = [
            `è¯Šæ–­: æ·±åº¦è§£æ„${genes.length}ä¸ªæ ¸å¿ƒæ–¹æ³•åŸºå› `,
            `å«æ¥: ç§»æ¤åˆ°${analysis.matched_domains.slice(0,2).join('ã€')}é¢†åŸŸ`,
            `æ¶æ„: ${genes.length * 4}å‘¨å®æ–½è·¯çº¿å›¾`,
            `ç‰©æ–™: ${genes.length * 2}å¥—ä¸“ä¸šæ¨¡æ¿`,
            `å˜ç°: ${genes.reduce((sum, g) => sum + g.complexity_level, 0) * 2}-${genes.reduce((sum, g) => sum + g.complexity_level, 0) * 4}ä¸‡æŠ¥ä»·`,
            `ååŒ: ${genes.length}ä¸ªèµ„æºæ¸ é“æ¨è`
        ];
        
        const detailHTML = isMobile ? 
            armDetails.map(detail => `<li style="margin: 8px 0;">${detail}</li>`).join('') :
            `<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                ${armDetails.map(detail => `<div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px;">${detail}</div>`).join('')}
            </div>`;
        
        document.getElementById('executionDetails').innerHTML = `
            <div style="background: rgba(255,255,255,0.05); padding: 18px; border-radius: 12px;">
                <h4 style="color: #00dbde; margin-bottom: 15px;">ğŸ“‹ è¯¦ç»†æ‰§è¡Œæ–¹æ¡ˆ</h4>
                ${isMobile ? `<ul style="margin: 0; padding-left: 20px;">${detailHTML}</ul>` : detailHTML}
                <div style="margin-top: 20px; text-align: center;">
                    <button class="arm-button" onclick="exportPlan()" style="background: #00dbde;">
                        ğŸ“¥ å¯¼å‡ºæ–¹æ¡ˆ
                    </button>
                </div>
            </div>
        `;
    }
    
    // ==================== å…­è‡‚åŠŸèƒ½ ====================
    function armFunction(armType) {
        if (!currentGenes || currentGenes.length === 0) {
            alert('è¯·å…ˆç”Ÿæˆæ™ºèƒ½åˆ†ææ–¹æ¡ˆ');
            return;
        }
        
        const armTitles = {
            diagnose: 'è¯Šæ–­è‡‚',
            graft: 'å«æ¥è‡‚', 
            architect: 'æ¶æ„è‡‚',
            material: 'ç‰©æ–™è‡‚',
            monetize: 'å˜ç°è‡‚',
            collaborate: 'ååŒè‡‚'
        };
        
        const primaryGene = currentGenes[0];
        
        alert(`å¯åŠ¨ã€${armTitles[armType]}ã€‘\n\nåŸºäºæ–¹æ³•åŸºå› : ${primaryGene.title}\n\nä¸“ä¸šç‰ˆç”¨æˆ·å¯äº«å—å®Œæ•´å·¥ä½œæµã€‚`);
    }
    
    // ==================== å•†ä¸šåŒ–åŠŸèƒ½ ====================
    function showCommercialPanel() {
        document.getElementById('commercialPanel').style.display = 'block';
        document.getElementById('commercialPanel').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }
    
    function selectPlan(planType) {
        const plans = {
            trial: { name: 'ä½“éªŒç‰ˆ', price: 299, desc: 'å•æ¬¡æ·±åº¦åˆ†ææŠ¥å‘Š' },
            pro: { name: 'ä¸“ä¸šç‰ˆ', price: 999, desc: 'æœˆåº¦æ— é™ç”Ÿæˆ + å•†ä¸šå·¥å…·' },
            enterprise: { name: 'ä¼ä¸šç‰ˆ', price: 9999, desc: 'å¹´åº¦åˆä¼™äºº + å®šåˆ¶æœåŠ¡' }
        };
        
        const plan = plans[planType];
        
        document.getElementById('commercialOutput').innerHTML = `
            <div style="background: rgba(0,219,222,0.1); padding: 20px; border-radius: 12px; margin-top: 20px;">
                <h4 style="color: #00dbde; margin-bottom: 15px;">ğŸ‰ é€‰æ‹© ${plan.name}</h4>
                <div style="text-align: center;">
                    <div style="font-size: 2rem; color: #fc00ff; font-weight: bold; margin: 15px 0;">Â¥${plan.price}</div>
                    <p style="margin: 10px 0; opacity: 0.9;">${plan.desc}</p>
                </div>
                <div style="display: flex; gap: 15px; margin-top: 25px; justify-content: center;">
                    <button class="arm-button" onclick="simulatePayment('${planType}')">
                        ğŸ’³ æ¨¡æ‹Ÿæ”¯ä»˜
                    </button>
                    <button class="arm-button" onclick="contactSales()" style="background: rgba(255,255,255,0.1);">
                        ğŸ“ è”ç³»å•†åŠ¡
                    </button>
                </div>
            </div>
        `;
    }
    
    function simulatePayment(planType) {
        alert(`ğŸ’° æ”¯ä»˜æµç¨‹æ¼”ç¤º\n\næ‚¨é€‰æ‹©äº† ${planType} å¥—é¤\n\nçœŸå®æ”¯ä»˜éœ€è¦é›†æˆ Stripe/æ”¯ä»˜å® API\n\nå½“å‰ä¸ºæ¼”ç¤ºæ¨¡å¼`);
    }
    
    function generateQuote() {
        if (!currentGenes || currentGenes.length === 0) {
            alert('è¯·å…ˆç”Ÿæˆæ™ºèƒ½åˆ†ææ–¹æ¡ˆ');
            return;
        }
        
        const totalComplexity = currentGenes.reduce((sum, g) => sum + g.complexity_level, 0);
        const basePrice = 3000 + (totalComplexity * 1500);
        
        const quoteHTML = `
            <div style="background: white; color: #333; padding: 20px; border-radius: 12px; margin-top: 20px;">
                <h3 style="color: #1a1a2e; margin-bottom: 15px; font-size: 1.2rem;">ğŸ“„ ä¸“ä¸šæœåŠ¡æŠ¥ä»·å•</h3>
                <div style="font-size: 0.95rem;">
                    <p style="margin: 10px 0;"><strong>é¡¹ç›®åç§°:</strong> ${currentAnalysis?.user_input?.substring(0, 30) || 'ä¸“ä¸šèƒ½åŠ›'} è·¨ç•Œæ–¹æ¡ˆ</p>
                    <p style="margin: 10px 0;"><strong>æŠ¥ä»·æ€»é¢:</strong> <span style="color: #fc00ff; font-size: 1.8rem; font-weight: bold;">Â¥${basePrice.toLocaleString()}</span></p>
                    <p style="margin: 10px 0;"><strong>æœåŠ¡å‘¨æœŸ:</strong> ${totalComplexity * 2} å‘¨</p>
                    <div style="margin: 15px 0;">
                        <strong>æ ¸å¿ƒæ–¹æ³•æ”¯æ’‘:</strong>
                        <ul style="margin: 8px 0 0 20px;">
                            ${currentGenes.slice(0,2).map(gene => 
                                `<li>${gene.title} (${gene.origin_domain})</li>`
                            ).join('')}
                        </ul>
                    </div>
                    <div style="text-align: center; margin-top: 25px;">
                        <button class="arm-button" onclick="downloadQuote()" 
                                style="background: #00dbde; padding: 12px 25px;">
                            ğŸ“¥ ä¸‹è½½æŠ¥ä»·å•
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('commercialOutput').innerHTML = quoteHTML;
    }
    
    // ==================== è¾…åŠ©å‡½æ•° ====================
    function focusGene(geneId) {
        const gene = currentGenes.find(g => g.id === geneId);
        if (gene) {
            // ç§»åŠ¨ç«¯æ»šåŠ¨ä¼˜åŒ–
            setTimeout(() => {
                document.getElementById('analysisSection').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 100);
            
            document.getElementById('analysisContent').innerHTML += `
                <div style="background: rgba(252,0,255,0.1); padding: 18px; border-radius: 12px; margin-top: 20px;">
                    <h4 style="color: #fc00ff; margin-bottom: 10px;">ğŸ¯ æ·±åº¦èšç„¦: ${gene.title}</h4>
                    <p style="margin: 10px 0; font-size: 0.95rem;"><strong>åº”ç”¨å»ºè®®:</strong> å°†æ­¤æ–¹æ³•åº”ç”¨äºæ‚¨çš„${currentAnalysis?.matched_domains[0] || 'ä¸“ä¸š'}å®è·µ</p>
                </div>
            `;
        }
    }
    
    function generateLocalFallback(userInput) {
        // æœ¬åœ°é™çº§é€»è¾‘
        const fallbackGenes = [
            {
                title: "é€šç”¨åˆ›æ–°æ¡†æ¶",
                description: "é€‚ç”¨äºå¤šé¢†åŸŸçš„ç»“æ„åŒ–åˆ›æ–°æ–¹æ³•è®º",
                origin_domain: "ç³»ç»Ÿé€šç”¨",
                tags: ["åˆ›æ–°", "æ¡†æ¶", "æ–¹æ³•è®º"],
                applicable_domains: ["é€šç”¨é¢†åŸŸ"],
                complexity_level: 2
            }
        ];
        
        currentGenes = fallbackGenes;
        
        // ç®€å•æ¸²æŸ“
        document.getElementById('literatureHead').textContent = "åŸºäºæœ¬åœ°çŸ¥è¯†åº“ç”Ÿæˆå™äº‹å»ºè®®";
        document.getElementById('musicHead').textContent = "è®¾è®¡é€šç”¨èŠ‚å¥ä¸ç»“æ„æ–¹æ¡ˆ";
        document.getElementById('filmHead').textContent = "ç­–åˆ’åŸºç¡€è§†è§‰è¡¨è¾¾æ¡†æ¶";
        
        document.getElementById('executionDetails').innerHTML = `
            <div style="color: #ff6b6b; text-align: center; padding: 20px;">
                <p>âš ï¸ å½“å‰ä¸ºæœ¬åœ°é™çº§æ¨¡å¼ï¼ŒåŠŸèƒ½å—é™</p>
                <p>å»ºè®®è¿æ¥åˆ°äº‘ç«¯æ™ºèƒ½å¼•æ“è·å¾—å®Œæ•´åŠŸèƒ½</p>
            </div>
        `;
    }
    
    // ==================== å·¥å…·å‡½æ•° ====================
    function exportPlan() { alert('ğŸ“¤ æ–¹æ¡ˆå¯¼å‡ºåŠŸèƒ½ï¼ˆä¸“ä¸šç‰ˆå¯ç”¨ï¼‰'); }
    function createProposal() { alert('ğŸ“‹ ææ¡ˆç”ŸæˆåŠŸèƒ½ï¼ˆä¸“ä¸šç‰ˆå¯ç”¨ï¼‰'); }
    function showContract() { alert('ğŸ“‘ åˆåŒæ¨¡æ¿åº“å·²å°±ç»ª'); }
    function calculateROI() { alert('ğŸ“Š ROIåˆ†æå™¨ï¼ˆä¸“ä¸šç‰ˆå¯ç”¨ï¼‰'); }
    function paymentOptions() { alert('ğŸ’³ æ”¯ä»˜è®¾ç½®ï¼ˆä¸“ä¸šç‰ˆå¯ç”¨ï¼‰'); }
    function contactSales() { alert('ğŸ“ å•†åŠ¡è”ç³»\nç”µè¯: 400-xxx-xxxx\né‚®ç®±: business@threeheads.com'); }
    function downloadQuote() { alert('ğŸ“¥ PDFç”Ÿæˆéœ€è¦æœåŠ¡å™¨æ”¯æŒ'); }
    
    // ==================== é¡µé¢åˆå§‹åŒ– ====================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ ä¸‰å¤´å…­è‡‚åˆ›ä¸–ç³»ç»Ÿ v2.0 å·²åŠ è½½');
        
        // åˆå§‹åŒ–å¸ƒå±€
        updateLayout();
        
        // ç›‘å¬çª—å£å˜åŒ–
        window.addEventListener('resize', updateLayout);
        
        // é˜²æ­¢åŒå‡»ç¼©æ”¾
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, { passive: false });
        
        // æµ‹è¯•APIè¿æ¥
        setTimeout(() => {
            fetch('/.netlify/functions/searchGenes?query=æµ‹è¯•')
                .then(() => {
                    document.getElementById('apiStatus').innerHTML = 
                        'äº‘ç«¯æ™ºèƒ½å¼•æ“ âœ“ åœ¨çº¿';
                    document.getElementById('apiStatus').style.color = '#00ff7f';
                })
                .catch(() => {
                    document.getElementById('apiStatus').innerHTML = 
                        'æ™ºèƒ½å¼•æ“ âœ— ç¦»çº¿ | éƒ¨åˆ†åŠŸèƒ½å—é™';
                    document.getElementById('apiStatus').style.color = '#ff6b6b';
                });
        }, 1000);
        
        // ä¼˜åŒ–ç§»åŠ¨ç«¯è¾“å…¥ä½“éªŒ
        const textarea = document.getElementById('userInput');
        if (textarea) {
            textarea.addEventListener('focus', function() {
                setTimeout(() => {
                    this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            });
        }
    });
    </script>
</body>
</html>
